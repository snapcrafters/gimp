name: gimp
version: '2.99.10'
summary: GNU Image Manipulation Program
description: |
  Whether you are a graphic designer, photographer, illustrator, or scientist,
  GIMP provides you with sophisticated tools to get your job done. You can
  further enhance your productivity with GIMP thanks to many customization
  options and 3rd party plugins.

grade: stable
confinement: strict
base: core22
compression: lzo

architectures:
- build-on: amd64
- build-on: arm64
# - build-on: armhf

layout:
  /etc/gimp:
    bind: $SNAP/etc/gimp
  /etc/ld.so.cache:
    bind-file: $SNAP_DATA/etc/ld.so.cache
  /usr/lib/$CRAFT_ARCH_TRIPLET/babl-0.1:
    bind: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/babl-0.1
  /usr/lib/$CRAFT_ARCH_TRIPLET/gegl-0.4:
    bind: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/gegl-0.4
  # /usr/lib/$CRAFT_ARCH_TRIPLET/darktable:
  #   bind: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/darktable
  /usr/lib/$CRAFT_ARCH_TRIPLET/evince/4/backends:
    bind: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/evince/4/backends
  /usr/lib/gimp:
    bind: $SNAP/usr/lib/gimp
  /usr/lib/python3.10:
    bind: $SNAP/usr/lib/python3.10
  /usr/lib/gvfs:
    bind: $SNAP/usr/lib/gvfs
  /usr/lib/$CRAFT_ARCH_TRIPLET/gvfs:
    bind: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/gvfs
  /usr/libexec:
    bind: $SNAP/usr/libexec
  /usr/share/color:
    bind: $SNAP/usr/share/color
  # /usr/share/darktable:
  #   bind: $SNAP/usr/share/darktable
  /usr/share/ghostscript:
    bind: $SNAP/usr/share/ghostscript
  /usr/share/gimp:
    bind: $SNAP/usr/share/gimp
  /usr/share/gvfs:
    bind: $SNAP/usr/share/gvfs
  /usr/share/lensfun:
    bind: $SNAP/usr/share/lensfun
  /usr/share/locale:
    bind: $SNAP/usr/share/locale
  /usr/share/mypaint-data:
    bind: $SNAP/usr/share/mypaint-data

# plugs:
  # color-profiles:
  #   interface: system-files
  #   read:
  #   - /usr/share/color/icc

slots:
  dbus-gimp:
    interface: dbus
    bus: session
    name: org.gimp.GIMP.UI

environment:
  GTK_USE_PORTAL: '1'
  GIMP2_LOCALEDIR: $SNAP/usr/share/locale
  LD_LIBRARY_PATH: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/lapack:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/blas
  PYTHONPATH: $SNAP/usr/lib/python3.10:$SNAP/usr/lib/python3.10/site-packages:$PYTHONPATH

apps:
  gimp:
    command: usr/bin/gimp
    extensions: [gnome]
    desktop: usr/share/applications/gimp.desktop
    common-id: org.gimp.GIMP
    slots:
    - dbus-gimp
    plugs:
    - cups-control
    - browser-support
    - desktop
    - desktop-legacy
    - gsettings
    - home
    - network
    - opengl
    - removable-media
    - unity7
    - wayland
    - x11

  # darktable:
  #   command: usr/bin/darktable
  #   command-chain: [snap/command-chain/desktop-launch]
  #   desktop: usr/share/applications/darktable.desktop
  #   common-id: darktable.desktop
  #   plugs:
  #   - cups-control
  #   - desktop
  #   - desktop-legacy
  #   - gsettings
  #   - home
  #   - network
  #   - opengl
  #   - removable-media
  #   - unity7
  #   - wayland
  #   - x11

parts:
  gexiv:
    plugin: meson
    source: https://download.gnome.org/sources/gexiv2/0.14/gexiv2-0.14.0.tar.xz
    source-checksum: sha256/e58279a6ff20b6f64fa499615da5e9b57cf65ba7850b72fafdf17221a9d6d69e
    meson-parameters:
    - --prefix=/usr
    - --buildtype=release
    - -Db_lto=true
    - -Dintrospection=false
    - -Dpython3=false
    - -Dvapi=false
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon
      - LDFLAGS: -mfpu=neon
    - else:
      - CFLAGS: -Ofast -g -pipe
      - CXXFLAGS: -Ofast -g -pipe
    build-packages:
    - libexiv2-dev
    - libcodec2-dev
    stage-packages:
    - libexiv2-27

  libav:
    after:
    - libaom
    plugin: autotools
    source: https://ffmpeg.org/releases/ffmpeg-5.1.tar.xz
    autotools-configure-parameters:
    - --prefix=/usr
    - --disable-programs
    - --disable-doc
    - --disable-alsa
    - --enable-gpl
    - --enable-shared
    - --enable-libaom
    - --enable-libfontconfig
    - --enable-libfreetype
    - --enable-librsvg
    - --enable-libv4l2
    - --enable-libvpx
    - --enable-libwebp
    - --enable-libx264
    - --enable-libx265
    - --enable-libxvid
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon
      - LDFLAGS: -mfpu=neon
    - else:
      - CFLAGS: -Ofast -g -pipe
      - CXXFLAGS: -Ofast -g -pipe
    build-packages:
    - to amd64:
      - libmfx-dev
    - libbz2-dev
    - libsdl2-dev
    - libtheora-dev
    - libv4l-dev
    - libva-dev
    - libvdpau-dev
    - libvpx-dev
    - libx264-dev
    - libx265-dev
    - libxvidcore-dev
    - nasm
    stage-packages:
    - to amd64:
      - libmfx1
    - libbz2-1.0
    - libsdl2-2.0-0
    - libtheora0
    - libv4l-0
    - libva2
    - libvdpau1
    - libvpx7
    - libx264-163
    - libx265-199
    - libxvidcore4

  # https://download.gimp.org/pub/babl
  babl:
    plugin: meson
    source: https://gitlab.gnome.org/GNOME/babl.git
    # source: https://download.gimp.org/pub/babl/0.1/babl-0.1.92.tar.xz
    # source-checksum: sha256/f667735028944b6375ad18f160a64ceb93f5c7dccaa9d8751de359777488a2c1
    meson-parameters:
    - --prefix=/usr
    - --buildtype=release
    - -Db_lto=true
    - -Dwith-docs=false
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon
      - LDFLAGS: -mfpu=neon
    - else:
      - CFLAGS: -Ofast -g -pipe
      - CXXFLAGS: -Ofast -g -pipe
    override-pull: |
      craftctl default
      sed -i 's/not stable, Description:/not stable, description:/' meson.build
    override-build: |
      # LTO fails on armhf
      LTO=-Db_lto=true
      if [ $CRAFT_ARCH_TRIPLET = "arm-linux-gnueabihf" ]; then
        LTO=-Db_lto=false
      fi

      meson \
        --prefix=/usr \
        --buildtype=release \
        -Dwith-docs=false \
        $LTO \
        $CRAFT_PART_SRC
      ninja
      DESTDIR=$CRAFT_PART_INSTALL ninja install
    build-packages:
    - git
    - meson
    - w3m
    prime:
    - -usr/include
    - -usr/lib/pkgconfig
    - -**/*.la

  # https://download.gimp.org/pub/gegl
  gegl:
    after:
    - babl
    - gexiv
    - ghostscript
    - libav
    source: https://gitlab.gnome.org/GNOME/gegl.git
    # source: https://download.gimp.org/pub/gegl/0.4/gegl-0.4.36.tar.xz
    # source-checksum: sha256/6fd58a0cdcc7702258adaeffb573a389228ae8f0eff47578efda2309b61b2ca6
    plugin: meson
    meson-parameters:
    - --prefix=/usr
    - --buildtype=release
    - -Ddocs=false
    - -Dworkshop=true
    - -Db_lto=true
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon
      - LDFLAGS: -mfpu=neon
    - else:
      - CFLAGS: -Ofast -g -pipe
      - CXXFLAGS: -Ofast -g -pipe
    - GIO_MODULE_DIR: /snap/gnome-42-2204-sdk/current/usr/lib/x86_64-linux-gnu/gio/modules
    override-build: |
      # LTO fails on armhf
      LTO=-Db_lto=true
      if [ $CRAFT_ARCH_TRIPLET = "arm-linux-gnueabihf" ]; then
        LTO=-Db_lto=false
      fi

      meson \
        --prefix=/usr \
        --buildtype=release \
        -Dworkshop=true \
        $LTO \
        $CRAFT_PART_SRC
      ninja
      DESTDIR=$CRAFT_PART_INSTALL ninja install
    build-packages:
    - libexiv2-dev
    - libfftw3-dev
    - libglu1-mesa-dev
    - liblensfun-dev
    - libluajit-5.1-dev
    - libmaxflow-dev
    - libopenexr-dev
    - libraw-dev
    - libsdl2-dev
    - libspiro-dev
    - libsuitesparse-dev
    - libv4l-dev
    - libwebp-dev
    - meson
    stage-packages:
    - libamd2
    - libbtf1
    - libcamd2
    - libccolamd2
    - libcholmod3
    - libcolamd2
    - libcxsparse3
    - libexiv2-27
    - libgraphblas6
    - libklu1
    - liblapack3
    - libldl2
    - liblensfun1
    - libluajit-5.1-2
    - libmaxflow0
    - libopenexr25
    - libraw20
    - librbio2
    - libsdl2-2.0-0
    - libspiro1
    - libspqr2
    - libumfpack5
    - libv4l-0
    stage:
    - -**/*.la
    - -etc
    - -var/lib/ucf
    - -usr/sbin/update-mime
    - -usr/share/X11
    - -usr/share/alsa
    - -usr/share/applications
    - -usr/share/apport
    - -usr/share/apps
    - -usr/share/binfmts
    - -usr/share/bug
    - -usr/share/debhelper
    - -usr/share/doc
    - -usr/share/doc-base
    - -usr/share/fonts
    - -usr/share/glib-2.0
    - -usr/share/libdrm
    - -usr/share/libthai
    - -usr/share/lintian
    - -usr/share/locale
    - -usr/share/man
    - -usr/share/menu
    - -usr/share/mime
    - -usr/share/perl5
    - -usr/share/pixmaps
    - -usr/share/pkgconfig
    - -usr/share/python
    - -usr/share/xml
    prime:
    - -usr/include
    - -usr/lib/pkgconfig
    - -usr/share/vala

  #Â https://aomedia.googlesource.com
  libaom:
    source: https://aomedia.googlesource.com/aom
    source-type: git
    plugin: cmake
    build-snaps: [cmake]
    build-environment:
    - to armhf:
      # LTO succeeds here, but breaks libheif build on armhf
      - CFLAGS: -Ofast -g -pipe -mfpu=neon
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon
      - LDFLAGS: -mfpu=neon
    - else:
      - CFLAGS: -Ofast -g -pipe -flto
      - CXXFLAGS: -Ofast -g -pipe -flto
      - LDFLAGS: -flto
    cmake-parameters:
    - -DCMAKE_BUILD_TYPE=Release
    - -DCMAKE_INSTALL_PREFIX=/usr
    - -DENABLE_DOCS=OFF
    - -DENABLE_EXAMPLES=OFF
    - -DENABLE_TESTDATA=OFF
    - -DENABLE_TESTS=OFF
    - -DCONFIG_PIC=1
    - -DCONFIG_AV1_ENCODER=1
    - -DCONFIG_AV1_DECODER=1
    - -DCONFIG_MULTITHREAD=1
    # Needs advanced grammar support from Snapcraft that isn't available here
    # Tested against Snapcraft 7.0 (beta - 2022-05-05 (7468)).
    # - to armhf:
    #   - -DAOM_NEON_INTRIN_FLAG=-mfpu=neon
    override-build: |
      EXTRA=""
      if [ $CRAFT_ARCH_TRIPLET = "arm-linux-gnueabihf" ]; then
        EXTRA="-DAOM_NEON_INTRIN_FLAG=-mfpu=neon"
      fi

      export DESTDIR="$CRAFT_PART_INSTALL"

      cmake $CRAFT_PART_SRC \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DENABLE_DOCS=OFF \
        -DENABLE_EXAMPLES=OFF \
        -DENABLE_TESTDATA=OFF \
        -DENABLE_TESTS=OFF \
        -DCONFIG_PIC=1 \
        -DCONFIG_AV1_ENCODER=1 \
        -DCONFIG_AV1_DECODER=1 \
        -DCONFIG_MULTITHREAD=1 \
        $EXTRA

      cmake --build . -- -j$CRAFT_PARALLEL_BUILD_COUNT

      cmake --build . --target install
    build-packages:
    - yasm

  # https://github.com/strukturag/libheif/releases
  libheif:
    after: [libaom]
    source: https://github.com/strukturag/libheif/releases/download/v1.12.0/libheif-1.12.0.tar.gz
    plugin: autotools
    build-environment:
    - to armhf:
      # LTO fails on armhf
      - CFLAGS: -Ofast -g -pipe -mfpu=neon
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon
      - LDFLAGS: -mfpu=neon
    - else:
      - CFLAGS: -Ofast -g -pipe -flto
      - CXXFLAGS: -Ofast -g -pipe -flto
      - LDFLAGS: -flto
    autotools-configure-parameters:
    - --prefix=/usr
    - --disable-go
    - --disable-examples
    build-packages:
    - libde265-dev
    - libx265-dev
    stage-packages:
    - libde265-0
    - libx265-199

  # https://github.com/mypaint/libmypaint/releases
  libmypaint:
    plugin: autotools
    source: https://github.com/mypaint/libmypaint/releases/download/v1.6.1/libmypaint-1.6.1.tar.xz
    source-checksum: sha256/741754f293f6b7668f941506da07cd7725629a793108bb31633fb6c3eae5315f
    build-packages:
    - intltool
    - libjson-c-dev
    autotools-configure-parameters:
    - --prefix=/usr
    - --disable-static
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - LDFLAGS: -mfpu=neon -flto
    - else:
      - CFLAGS: -Ofast -g -pipe -flto
      - CXXFLAGS: -Ofast -g -pipe -flto
      - LDFLAGS: -flto
    stage:
    - -**/*.la
    prime:
    - -usr/include
    - -usr/lib/pkgconfig

  # https://github.com/mypaint/mypaint-brushes/releases
  mypaint-brushes:
    after:
    - libmypaint
    source: https://github.com/mypaint/mypaint-brushes/releases/download/v1.3.1/mypaint-brushes-1.3.1.tar.xz
    source-checksum: sha256/fef66ffc241b7c5cd29e9c518e933c739618cb51c4ed4d745bf648a1afc3fe70
    plugin: autotools
    autotools-configure-parameters:
    - --prefix=/usr
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - LDFLAGS: -mfpu=neon -flto
    - else:
      - CFLAGS: -Ofast -g -pipe -flto
      - CXXFLAGS: -Ofast -g -pipe -flto
      - LDFLAGS: -flto
    build-packages:
    - automake

  #Â https://github.com/hughsie/appstream-glib
  appstream-glib:
    plugin: meson
    source: https://github.com/hughsie/appstream-glib.git
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon
      - LDFLAGS: -mfpu=neon
    - else:
      - CFLAGS: -Ofast -g -pipe
      - CXXFLAGS: -Ofast -g -pipe
    meson-parameters:
    - --prefix=/usr
    - --buildtype=release
    - -Db_lto=true
    - -Dbuilder=false
    - -Drpm=false
    - -Dman=false
    build-packages:
    - gperf
    - libarchive-dev
    - libstemmer-dev
    - libyaml-dev
    stage-packages:
    - libarchive13
    - libstemmer0d
    - libyaml-0-2

  #Â https://gitlab.gnome.org/GNOME/evince
  evince:
    source: https://gitlab.gnome.org/GNOME/evince.git
    source-type: git
    source-branch: 'gnome-42'
    plugin: meson
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - LDFLAGS: -mfpu=neon -flto
    - else:
      - CFLAGS: -Ofast -g -pipe -flto
      - CXXFLAGS: -Ofast -g -pipe -flto
      - LDFLAGS: -flto
    meson-parameters:
    - --prefix=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr
    - --buildtype=release
    - -Dnautilus=false
    - -Dgtk_doc=false
    - -Dintrospection=false
    organize:
      snap/$SNAPCRAFT_PROJECT_NAME/current/usr: usr
    build-packages:
    - autotools-dev
    - dh-apparmor
    - intltool
    - libarchive-dev
    - libdjvulibre-dev
    # - libgstreamer-plugins-base1.0-dev
    # - libgstreamer1.0-dev
    - libkpathsea-dev
    - libsm-dev
    stage-packages:
    - libarchive13
    - libdjvulibre21
    - libkpathsea6
    - libnspr4
    # - libnss3

  #Â https://github.com/ArtifexSoftware/ghostpdl-downloads
  ghostscript:
    plugin: autotools
    source: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9561/ghostscript-9.56.1.tar.xz
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - LDFLAGS: -mfpu=neon -flto
    - else:
      - CFLAGS: -Ofast -g -pipe -flto
      - CXXFLAGS: -Ofast -g -pipe -flto
      - LDFLAGS: -flto
    autotools-configure-parameters:
    - --prefix=/usr
    - --disable-compile-inits
    - --enable-dynamic
    override-build: |
      ./configure \
        --prefix=/usr \
        --disable-compile-inits \
        --enable-dynamic
      make -j$CRAFT_PARALLEL_BUILD_COUNT 
      make -j$CRAFT_PARALLEL_BUILD_COUNT so
      make DESTDIR=$CRAFT_PART_INSTALL install
      make DESTDIR=$CRAFT_PART_INSTALL soinstall

  # https://www.rawtherapee.com/downloads/
  rawtherapee:
    source: https://rawtherapee.com/shared/source/rawtherapee-5.8.tar.xz
    plugin: cmake
    override-pull: |
      craftctl default
      patch -Np1 -i $CRAFT_PROJECT_DIR/patches/rawtherapee.patch
    cmake-parameters:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/usr
      - -DWITH_LTO=ON
      - -DCACHE_NAME_SUFFIX=""
    build-environment:
    # -Ofast enables -ffast-math which is incompatible with rawtherapee so use -O3 instead
    - to armhf:
      - CFLAGS: -O3 -g -pipe -mfpu=neon
      - CXXFLAGS: -O3 -g -pipe -mfpu=neon
      - LDFLAGS: -mfpu=neon
    - else:
      - CFLAGS: -O3 -g -pipe
      - CXXFLAGS: -O3 -g -pipe
    build-packages:
    - libiptcdata0-dev
    - liblensfun-dev
    stage-packages:
    - libiptcdata0
    - liblensfun1

  #Â https://github.com/caolanm/libwmf
  libwmf:
    after: [ghostscript]
    plugin: autotools
    source: https://github.com/caolanm/libwmf/archive/refs/tags/v0.2.12.tar.gz
    override-pull: |
      craftctl default
      patch -Np1 -i $CRAFT_PROJECT_DIR/patches/libwmf/no-trio.patch
      patch -Np1 -i $CRAFT_PROJECT_DIR/patches/libwmf/freetype-pkg-config.patch
      autoreconf --force --install --include=patches
    autotools-configure-parameters:
    - --prefix=/usr
    - --with-gsfontmap=/usr/share/ghostscript/9.56.1/Resource/Init/Fontmap.GS
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - LDFLAGS: -mfpu=neon -flto
    - else:
      - CFLAGS: -Ofast -g -pipe -flto
      - CXXFLAGS: -Ofast -g -pipe -flto
      - LDFLAGS: -flto
    override-build: |
      craftctl default
      sed -i "s|/usr/lib/libwmflite.la|$CRAFT_STAGE/usr/lib/libwmflite.la|" $CRAFT_PART_INSTALL/usr/lib/libwmf.la
    stage-packages:
    - libexpat1

  # https://download.gimp.org/pub/gimp/v2.10/
  gimp:
    after:
    - appstream-glib
    - babl
    - evince
    - gegl
    - gexiv
    - ghostscript
    - libheif
    - libmypaint
    - libwmf
    - mypaint-brushes
    - rawtherapee
    plugin: autotools
    source: https://gitlab.gnome.org/GNOME/gimp.git
    # meson-parameters:
    # - --prefix=/usr
    # - --buildtype=release
    # - -Dgi-docgen=disabled
    # - -Dbuild-id=org.gimp.GIMP.snapcraft.edge
    # - -Dbug-report-url=https://github.com/snapcrafters/gimp/issues/
    # - -Dcheck-update=no
    autotools-configure-parameters:
    - --prefix=/usr
    - --sysconfdir=/etc
    - --with-build-id=org.gimp.GIMP.snapcraft.edge
    - --with-bug-report-url=https://github.com/snapcrafters/gimp/issues/
    - --enable-check-update=no
    - --enable-gi-docgen=no
    - --enable-g-ir-doc=no
    - --enable-default-binary=yes
    build-environment:
    - to armhf:
      - CFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - CXXFLAGS: -Ofast -g -pipe -mfpu=neon -flto
      - LDFLAGS: -mfpu=neon -flto
    - else:
      - CFLAGS: -Ofast -g -pipe -flto
      - CXXFLAGS: -Ofast -g -pipe -flto
      - LDFLAGS: -flto
    - BABL_PATH: $CRAFT_STAGE/usr/lib/$CRAFT_ARCH_TRIPLET/babl-0.1
    - GEGL_PATH: $CRAFT_STAGE/usr/lib/$CRAFT_ARCH_TRIPLET/gegl-0.4
    # the LIBRARY_PATH is to fix ld unable to find libwmf
    - LIBRARY_PATH: $CRAFT_STAGE/usr/lib
    # the LD_LIBRARY_PATH is to fix configure failing to test for gegl matting-levin support
    - LD_LIBRARY_PATH: $LD_LIBRARY_PATH:$CRAFT_STAGE/usr/lib/$CRAFT_ARCH_TRIPLET
    - GIO_MODULE_DIR: /snap/gnome-42-2204-sdk/current/usr/lib/x86_64-linux-gnu/gio/modules
    - PYTHON: /usr/bin/python3.10
    override-pull: |
      craftctl default
      sed -i 's|^Icon=.*|Icon=/usr/share/icons/hicolor/256x256/apps/gimp.png|' desktop/gimp.desktop.in.in
    override-build: |
      # rm -f $CRAFT_PART_INSTALL/usr/share/pkgconfig/iso-codes.pc
      craftctl default
      # sed -i -E "s|^(.*python3?=).*|\1/snap/$CRAFT_PROJECT_NAME/current/usr/bin/python|" $CRAFT_PART_INSTALL/usr/lib/gimp/2.99/interpreters/pygimp.interp || true
      sed -i -E 's|^# \(mypaint-brush-path .*$|(mypaint-brush-path "/usr/share/mypaint-data/1.0/brushes:~/.mypaint/brushes")|' $CRAFT_PART_INSTALL/etc/gimp/2.99/gimprc
    build-packages:
    - automake
    - intltool
    - iso-codes
    - libaa1-dev
    - libart-2.0-dev
    - libbz2-dev
    - libexif-dev
    - libexpat1-dev
    - libfftw3-dev
    - libgpm-dev
    - libice-dev
    - libilmbase-dev
    - libisocodes-dev
    - libluajit-5.1-dev
    - liblzma-dev
    - libmng-dev
    - libopenexr-dev
    - libslang2-dev
    - libsm-dev
    - libwebp-dev
    - libxmu-dev
    - libxpm-dev
    - luajit
    - poppler-data
    - xdg-utils
    - xsltproc
    - libunwind-dev
    stage-packages:
    # - gvfs-backends
    - libaa1
    - libart-2.0-2
    - libbz2-1.0
    - libexif12
    - libfftw3-3
    - libgpm2
    - libilmbase25
    - libluajit-5.1-2
    - liblzma5
    - libmng2
    - libopenexr25
    - libslang2
    - libwebp7
    - libwebpdemux2
    - libwebpmux3
    - libxmu6
    - libxpm4
    - luajit
    - poppler-data
    - libunwind8
    stage:
    - -**/*.la
    - -etc/dbus-1
    - -etc/default
    - -etc/dictionaries-common
    - -etc/emacs
    - -etc/fonts
    - -etc/glvnd
    - -etc/gnome
    - -etc/gss
    - -etc/gtk-3.0
    - -etc/init.d
    - -etc/libblockdev
    - -etc/libpaper.d
    - -etc/mailcap.order
    - -etc/mime.types
    - -etc/rc*.d
    - -etc/sensors3.conf
    - -etc/systemd
    - -etc/ucf.conf
    - -etc/udisks2
    - -etc/X11
    - -sbin/cfdisk
    - -sbin/cgdisk
    - -sbin/fdisk
    - -sbin/fixparts
    - -sbin/gdisk
    - -sbin/parted
    - -sbin/partprobe
    - -sbin/sfddisk
    - -sbin/sgdisk
    - -usr/bin/aspell*
    - -usr/bin/dbus*
    - -usr/bin/desktop-file-*
    - -usr/bin/fc-*
    - -usr/bin/gtk-update-icon-cache
    - -usr/bin/ispell*
    - -usr/bin/mtrace
    - -usr/bin/rpcgen
    - -usr/bin/run-*
    - -usr/bin/select-default-iwrap
    - -usr/bin/update-*-database
    - -usr/bin/xdpyinfo
    - -usr/bin/xdriinfo
    - -usr/bin/xev
    - -usr/bin/xfd
    - -usr/bin/xfontsel
    - -usr/bin/xkill
    - -usr/bin/xlsatoms
    - -usr/bin/xlsclients
    - -usr/bin/xlsfonts
    - -usr/bin/xmessage
    - -usr/bin/xprop
    - -usr/bin/xvinfo
    - -usr/bin/xwininfo
    - -usr/lib/aspell
    - -usr/lib/$CRAFT_ARCH_TRIPLET/pkgconfig/libcrypt.pc
    - -usr/lib/$CRAFT_ARCH_TRIPLET/pkgconfig/libxcrypt.pc
    - -usr/share/doc/libjpeg*
    - -usr/share/ghostscript
    - -usr/share/pkgconfig/iso-codes.pc
    - -**/iso-codes
    - -var/cache
    - -var/lib/aspell
    - -var/lib/dbus
    - -var/lib/dictionaries-common
    - -var/lib/emacsen-common
    - -var/lib/ispell
    - -var/lib/systemd
    - -var/lib/ucf
    prime:
    - -usr/include
    - -usr/lib/pkgconfig

  # gmic:
  #   after: [appstream-glib, gexiv, gimp]
  #   plugin: nil
  #   override-pull: |
  #     git clone https://github.com/dtschump/gmic.git
  #     git clone https://github.com/dtschump/CImg.git
  #     git clone https://github.com/c-koi/gmic-qt.git
  #     cd gmic-qt
  #     # VERSION="$(git tag -l 'v.*.*' --sort=version:refname | tail -n1)"
  #     VERSION=v.2.9.6
  #     git checkout "$VERSION"
  #     cd ../gmic
  #     git checkout "$VERSION"
  #     cd ../CImg
  #     git checkout "$VERSION"
  #   override-build: |
  #     make -C gmic/src CImg.h gmic_stdlib.h
  #     cd gmic-qt
  #     mkdir build
  #     cd build
  #     cmake .. \
  #       -DCMAKE_INSTALL_PREFIX=/usr \
  #       -DGMIC_QT_HOST=gimp \
  #       -DGMIC_PATH=$CRAFT_PART_BUILD/gmic/src \
  #       -DCMAKE_BUILD_TYPE=Release
  #     make -j$CRAFT_PARALLEL_BUILD_COUNT
  #     make DESTDIR=$CRAFT_PART_INSTALL install
  #   build-environment:
  #   - PATH: /snap/bin:$PATH
  #   - to armhf:
  #     - CFLAGS: -Ofast -g -pipe -mfpu=neon -flto
  #     - CXXFLAGS: -Ofast -g -pipe -mfpu=neon -flto
  #     - LDFLAGS: -mfpu=neon -flto
  #   - else:
  #     - CFLAGS: -Ofast -g -pipe -flto
  #     - CXXFLAGS: -Ofast -g -pipe -flto
  #     - LDFLAGS: -flto
  #   build-packages:
  #     - curl
  #     - libarchive-dev
  #     - libfftw3-dev
  #     - libgraphicsmagick++1-dev
  #     - libgraphicsmagick1-dev
  #     - libluajit-5.1-dev
  #     - libopencv-core-dev
  #     - libopencv-highgui-dev
  #     - libopencv-videoio-dev
  #     # - libopencv-imgcodecs-dev
  #     # - libopencv-imgproc-dev
  #     - libopenexr-dev
  #     - libxres-dev
  #     - luajit
  #     - make
  #     - qt5-qmake
  #     - qtbase5-dev
  #     - qtbase5-dev-tools
  #     - qtchooser
  #     - qttools5-dev
  #     - wget
  #   stage-packages:
  #     - libarchive13
  #     - libdouble-conversion3
  #     - libfftw3-3
  #     - libgraphicsmagick-q16-3
  #     - libgraphicsmagick++-q16-12
  #     - libluajit-5.1-2
  #     - libopencv-core4.5d
  #     - libopencv-highgui4.5d
  #     - libopencv-videoio4.5d
  #     - libopenexr25
  #     - libqt5core5a
  #     - libqt5gui5
  #     - libqt5network5
  #     - libqt5widgets5
  #     - libxres1
  #     - luajit
  #     - qtwayland5

  # # https://github.com/darktable-org/darktable/releases
  # darktable:
  #   after: [gimp, gmic]
  #   source: https://github.com/darktable-org/darktable/releases/download/release-3.0.2/darktable-3.0.2.tar.xz
  #   source-checksum: sha256/6abaf661fe9414e92bdb33b58b98ef024ccf6132b7876abaf0751ec2109f36fb
  #   plugin: cmake
  #   build-snaps: [cmake]
  #   override-pull: |
  #     craftctl default
  #     sed -i 's|Exec=.*|Exec=darktable %U|;s|TryExec=.*|TryExec=darktable|;s|Icon=.*|Icon=${SNAP}/usr/share/icons/hicolor/scalable/apps/darktable.svg|' data/darktable.desktop.in
  #   cmkae-parameters:
  #     - -DCMAKE_BUILD_TYPE=Release
  #     - -DCMAKE_INSTALL_PREFIX=/usr
  #   build-environment:
  #     - CFLAGS: -Ofast -g -pipe -flto
  #     - CXXFLAGS: -Ofast -g -pipe -flto
  #     - LDFLAGS: -flto
  #   build-snaps: [cmake]
  #   build-packages:
  #     - curl
  #     - freeglut3-dev
  #     - fop
  #     - intltool
  #     - libflickcurl-dev
  #     - libgnome-keyring-dev
  #     - libgphoto2-dev
  #     - libgraphicsmagick1-dev
  #     - liblensfun-dev
  #     - liblua5.3-dev
  #     - libopenexr-dev
  #     - libosmgpsmap-1.0-dev
  #     - libpugixml-dev
  #     - libsdl1.2-dev
  #     - libwebp-dev
  #     - xsltproc
  #   stage-packages:
  #     - freeglut3
  #     - libexiv2-27
  #     - libflickcurl0
  #     - libgnome-keyring0
  #     - libgphoto2-6
  #     - libgraphicsmagick-q16-3
  #     - liblensfun1
  #     - liblensfun-data-v1
  #     - liblua5.3-0
  #     - libopenexr25
  #     - libosmgpsmap-1.0-1
  #     - libpugixml1v5
  #     - libsdl1.2debian
  #     - libwebp7

  cleanup:
    after: [ gimp ] #, gmic ]
    plugin: nil
    build-snaps:
    - core22
    - gnome-42-2204
    - gtk-common-themes
    override-prime: |
      set -eux
      for snap in "gnome-42-2204" "gtk-common-themes"; do  # List all content-snaps you're using here
        cd "/snap/$snap/current" && find . -type f,l -exec rm -f "$CRAFT_PRIME/{}" \;
      done
      for CRUFT in bug lintian man; do
        rm -rf $CRAFT_PRIME/usr/share/$CRUFT
      done
      find $CRAFT_PRIME/usr/share/doc/ -type f -not -name 'copyright' -delete
      find $CRAFT_PRIME/usr/share -type d -empty -not -path "$CRAFT_PRIME/usr/share/gimp/*" -delete
